<template>
  <div :key="componentKey" class="py-6 px-8">
    <div class="grid grid-rows-1 xl:grid-cols-3 gap-4 mb-6">
      <div class="bg-white px-10 pt-10 pb-24">
        <p class="font-medium text-black tracking-wide pb-4">Total GRN</p>
        <div class="relative space-x-4 flex justify-between">
          <p class="absolute bottom-0 left-0 top-4 font-medium text-5xl">834</p>
          <svg
            width="117"
            height="69"
            class="absolute bottom-0 right-0 top-0"
            viewBox="0 0 117 69"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              opacity="0.2"
              d="M85 19C85 17.8954 85.8954 17 87 17H97C98.1046 17 99 17.8954 99 19V69H85V19Z"
              fill="#61A4E4"
            />
            <path
              opacity="0.2"
              d="M103 43C103 41.8954 103.895 41 105 41H115C116.105 41 117 41.8954 117 43V69H103V43Z"
              fill="#61A4E4"
            />
            <path
              d="M68 32C68 30.8954 68.8954 30 70 30H80C81.1046 30 82 30.8954 82 32V69H68V32Z"
              fill="#61A4E4"
            />
            <path
              opacity="0.2"
              d="M51 2C51 0.89543 51.8954 0 53 0H63C64.1046 0 65 0.895431 65 2V69H51V2Z"
              fill="#61A4E4"
            />
            <path
              opacity="0.2"
              d="M34 24C34 22.8954 34.8954 22 36 22H46C47.1046 22 48 22.8954 48 24V69H34V24Z"
              fill="#61A4E4"
            />
            <path
              opacity="0.2"
              d="M17 35C17 33.8954 17.8954 33 19 33H29C30.1046 33 31 33.8954 31 35V69H17V35Z"
              fill="#61A4E4"
            />
            <path
              opacity="0.2"
              d="M0 64C0 62.8954 0.895431 62 2 62H12C13.1046 62 14 62.8954 14 64V69H0V64Z"
              fill="#61A4E4"
            />
          </svg>
        </div>
      </div>
      <div class="bg-white px-10 pt-10 pb-24">
        <p class="font-medium text-black tracking-wide pb-4">Approved GRN</p>
        <div class="relative space-x-4 flex justify-between">
          <p class="absolute bottom-0 left-0 top-4 font-medium text-5xl">399</p>
          <svg
            width="117"
            height="69"
            viewBox="0 0 117 69"
            class="absolute bottom-0 right-0 top-0"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              opacity="0.2"
              d="M85 19C85 17.8954 85.8954 17 87 17H97C98.1046 17 99 17.8954 99 19V69H85V19Z"
              fill="#62CFA6"
            />
            <path
              opacity="0.2"
              d="M103 43C103 41.8954 103.895 41 105 41H115C116.105 41 117 41.8954 117 43V69H103V43Z"
              fill="#62CFA6"
            />
            <path
              opacity="0.2"
              d="M68 32C68 30.8954 68.8954 30 70 30H80C81.1046 30 82 30.8954 82 32V69H68V32Z"
              fill="#62CFA6"
            />
            <path
              opacity="0.2"
              d="M51 2C51 0.89543 51.8954 0 53 0H63C64.1046 0 65 0.895431 65 2V69H51V2Z"
              fill="#62CFA6"
            />
            <path
              d="M34 24C34 22.8954 34.8954 22 36 22H46C47.1046 22 48 22.8954 48 24V69H34V24Z"
              fill="#62CFA6"
            />
            <path
              opacity="0.2"
              d="M17 35C17 33.8954 17.8954 33 19 33H29C30.1046 33 31 33.8954 31 35V69H17V35Z"
              fill="#62CFA6"
            />
            <path
              opacity="0.2"
              d="M0 64C0 62.8954 0.895431 62 2 62H12C13.1046 62 14 62.8954 14 64V69H0V64Z"
              fill="#62CFA6"
            />
          </svg>
        </div>
      </div>
      <div class="bg-white px-10 pt-10 pb-24">
        <p class="font-medium text-black tracking-wide pb-4">Pending GRN</p>
        <div class="relative space-x-4 flex justify-between">
          <p class="absolute bottom-0 left-0 top-4 font-medium text-5xl">435</p>
          <svg
            width="117"
            height="69"
            class="absolute bottom-0 right-0 top-0"
            viewBox="0 0 117 69"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              opacity="0.2"
              d="M85 19C85 17.8954 85.8954 17 87 17H97C98.1046 17 99 17.8954 99 19V69H85V19Z"
              fill="#FFB269"
            />
            <path
              opacity="0.2"
              d="M103 43C103 41.8954 103.895 41 105 41H115C116.105 41 117 41.8954 117 43V69H103V43Z"
              fill="#FFB269"
            />
            <path
              opacity="0.2"
              d="M68 32C68 30.8954 68.8954 30 70 30H80C81.1046 30 82 30.8954 82 32V69H68V32Z"
              fill="#FFB269"
            />
            <path
              d="M51 2C51 0.89543 51.8954 0 53 0H63C64.1046 0 65 0.895431 65 2V69H51V2Z"
              fill="#FFB269"
            />
            <path
              opacity="0.2"
              d="M34 24C34 22.8954 34.8954 22 36 22H46C47.1046 22 48 22.8954 48 24V69H34V24Z"
              fill="#FFB269"
            />
            <path
              opacity="0.2"
              d="M17 35C17 33.8954 17.8954 33 19 33H29C30.1046 33 31 33.8954 31 35V69H17V35Z"
              fill="#FFB269"
            />
            <path
              opacity="0.2"
              d="M0 64C0 62.8954 0.895431 62 2 62H12C13.1046 62 14 62.8954 14 64V69H0V64Z"
              fill="#FFB269"
            />
          </svg>
        </div>
      </div>
    </div>
    <div class="bg-white px-6 py-4 mt-6">
      <div class="flex items-center justify-around px-2 py-2 space-x-4 w-full">
        <filter-component />
        <search-component :place-holder="'Search for GRN'" />
        <button
          class="
            px-4
            py-2
            rounded-sm
            text-white
            bg-btn-purple
            flex
            items-center
            space-x-4
          "
          @click="showRecieveProduct = !showRecieveProduct"
        >
          <svg
            class="w-3 h-3 fill-current text-white"
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 341.4 341.4"
          >
            <path
              d="M192 149.4V0h-42.6v149.4H0V192h149.4v149.4H192V192h149.4v-42.6z"
            />
          </svg>
          <span> Create GRN</span>
        </button>
        <pagination
          :pagination-details="paginationProp"
          @next="changePage($event.value)"
          @prev="changePage($event.value)"
        />
      </div>
      <table class="w-full table-auto mt-2">
        <thead class="bg-gray-100">
          <tr>
            <th class="w-6 px-6 py-4">
              <input
                type="checkbox"
                class="border border-gray-500 rounded-sm"
              />
            </th>
            <th
              v-for="(headSingle, index) in headers"
              :key="index"
              class="
                uppercase
                text-gray-800
                font-thin
                text-sm
                px-4
                py-2
                text-center
              "
            >
              {{ headSingle }}
            </th>
            <th
              class="
                uppercase
                text-gray-800
                font-thin
                text-sm
                px-4
                py-2
                text-center
              "
            >
              Action
            </th>
          </tr>
        </thead>
        <tbody>
          <tr
            v-for="(inventory, i) in inventories"
            :key="i"
            class="font-light hover:bg-gray-100"
          >
            <td class="w-6 px-6 py-4">
              <input
                type="checkbox"
                class="border-2 border-gray-400 rounded-sm"
              />
            </td>
            <td class="px-4 text-center py-4">
              {{ inventory.grn ? inventory.grn : 'Not Specified' }}
            </td>
            <td class="px-4 text-center py-4">{{ inventory.supplier }}</td>
            <td class="px-4 text-center py-4">{{ inventory.LPOnumber }}</td>
            <td class="px-4 text-center py-4">{{ inventory.wayBillNumber }}</td>
            <td class="px-4 text-center py-4">{{ inventory.invoiceNumber }}</td>
            <td class="px-4 text-center py-4">
              <span class="px-4 py-2 bg-yellow-100 text-red-400">
                Pending
              </span>
            </td>
            <td class="px-4 text-center py-4">
              {{ new Date(inventory.dateReceived).toDateString() }}
            </td>
            <td class="px-4 text-center py-4">
              <button
                class="
                  px-2
                  py-1
                  border border-btn-purple
                  rounded-sm
                  text-btn-purple text-sm
                "
                @click="getInventory(inventory._id)"
              >
                View Details
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    <recieve-product
      v-if="showRecieveProduct"
      @reload="getInventories(1)"
      @close="showRecieveProduct = false"
    />
    <recieve-product-detail
      v-if="showRecieveDetails"
      :inventory="inventoryDetails"
      @close="showRecieveDetails = !showRecieveDetails"
    />
  </div>
</template>
<script lang="ts">
import {
  defineComponent,
  ref,
  onMounted,
  reactive,
} from '@nuxtjs/composition-api'
import Pagination from '@/components/Base/Pagination.vue'
import SearchComponent from '@/components/Base/Search.vue'
import FilterComponent from '@/components/Base/Filter.vue'
import RecieveProduct from '@/components/Overlays/RecieveProducts.vue'
import RecieveProductDetail from '@/components/Overlays/RecieveProductDetail.vue'
import { ProductObject } from '@/module/Product'

export default defineComponent({
  name: 'Analytics',
  components: {
    Pagination,
    SearchComponent,
    FilterComponent,
    RecieveProduct,
    RecieveProductDetail,
  },
  layout: 'dashboard',
  setup() {
    const headers = [
      'Grn No.',
      'Supplier',
      'LPO No',
      'WayBill No',
      'Invoice No',
      'Status',
      'Date',
    ]
    const inventories = ref<any>([])
    const showRecieveProduct = ref(false)

    const showRecieveDetails = ref(false)
    const inventoryDetails = ref()

    const componentKey = ref(0)

    const paginationProp = reactive({
      hasNextPage: false,
      hasPrevPage: false,
      currentPage: 1,
    })

    function changePage(nextPage: number) {
      getInventories(nextPage)
    }

    function getInventories(pageNumber: number) {
      ProductObject.fetchInventories(pageNumber).then((response) => {
        const myResponse = response.data.inventory
        inventories.value = myResponse.docs
        paginationProp.hasNextPage = myResponse.hasNextPage
        paginationProp.hasPrevPage = myResponse.hasPrevPage
        paginationProp.currentPage = myResponse.page
      })
    }

    function getInventory(value: String) {
      ProductObject.fetchInventory(value).then((response) => {
        inventoryDetails.value = response.data.data
        showRecieveDetails.value = !showRecieveDetails.value
      })
    }

    function getInventoryStat() {
      ProductObject.fetchInventoryStatistics().then((response) => {
        console.log(response)
      })
    }

    onMounted(() => {
      getInventories(1)
      getInventoryStat()
    })

    return {
      headers,
      inventories,
      showRecieveProduct,
      getInventory,
      showRecieveDetails,
      inventoryDetails,
      componentKey,
      paginationProp,
      changePage,
      getInventories,
    }
  },
})
</script>
